(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.Lizi=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.CanvasRenderer=void 0;var renderer_1=require("../renderer");var CanvasRenderer=function(){function CanvasRenderer(canvas){this.canvas=canvas;this.emitters=[];this.currentTime=0;this.birthedTime=-1;this.allParticles=[];this.deathRange={};this.context=canvas.getContext("2d")}CanvasRenderer.prototype.addEmitter=function(emitter){this.emitters.push(emitter)};CanvasRenderer.prototype.removeEmitter=function(emitter){var targetIndex=this.emitters.indexOf(emitter);if(targetIndex>=0){delete this.emitters[targetIndex]}};CanvasRenderer.prototype.removeAllEmitters=function(){this.emitters=[]};CanvasRenderer.prototype.onTick=function(time){this.currentTime=time;this.birth();this.render()};CanvasRenderer.prototype.birth=function(){var _a,_b;if(this.birthedTime<0||this.birthedTime+1e3<this.currentTime){for(var emitterIndex=0;emitterIndex<this.emitters.length;emitterIndex++){var emitter=this.emitters[emitterIndex];for(var cellIndex=0;cellIndex<emitter.cells.length;cellIndex++){var cell=emitter.cells[cellIndex];var cellBirthRate=emitter.birthRate*cell.birthRate;for(var index=0;index<cellBirthRate;index++){var particle=new _Particle;particle.texture=cell.contents;particle.size=(_b=(_a=cell.contents)===null||_a===void 0?void 0:_a.width)!==null&&_b!==void 0?_b:0;particle.delay=Math.random()*1e3;particle.maxLife=(cell.lifttime+-cell.lifttimeRange/2+Math.random()*cell.lifttimeRange)*1e3;var adjustRotation=new renderer_1._RotationAdjusting;particle.position=renderer_1.RendererUtils.getPosition(emitter,adjustRotation);var emissionLongitude=cell.emissionLongitude-cell.emissionRange/2+Math.random()*cell.emissionRange;if(adjustRotation.value!=0){emissionLongitude+=adjustRotation.value}var theXPositionSpeed=cell.velocity-cell.velocityRange/2+Math.random()*cell.velocityRange;particle.velocity={x:theXPositionSpeed*Math.cos(emissionLongitude),y:theXPositionSpeed*Math.sin(emissionLongitude)};particle.acceleration=cell.acceleration;particle.scale=cell.scale-cell.scaleRange/2+Math.random()*cell.scaleRange;particle.scaleSpeed=cell.scaleSpeed;particle.alpha=1-cell.alphaRange/2+Math.random()*cell.alphaRange;particle.alphaSpeed=cell.alphaSpeed;particle.rotation=0;particle.rotationSpeed=cell.spin-cell.spinRange/2+Math.random()*cell.spinRange;this.addParticle(particle)}}}this.birthedTime=this.currentTime}};CanvasRenderer.prototype.render=function(){this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height);for(var index=0;index<this.allParticles.length;index++){var element=this.allParticles[index];this.renderParticleItem(element)}};CanvasRenderer.prototype.renderParticleItem=function(particle){var currentTime=this.currentTime-particle.startLife;var texture=particle.texture;if(!texture)return;var startTime=particle.startLife;var endTime=particle.startLife+particle.maxLife;if(particle.repeat){var nTime=this.currentTime-startTime;var segTime=endTime-startTime;currentTime=nTime-Math.floor(nTime/segTime)*segTime}else if(currentTime<0||currentTime>endTime){return}var currentScale=particle.scale+particle.scaleSpeed*(currentTime/1e3);var currentPosition={x:particle.position.x+particle.velocity.x*(currentTime/1e3)+.5*particle.acceleration.x*(currentTime/1e3)*(currentTime/1e3),y:particle.position.y+particle.velocity.y*(currentTime/1e3)+.5*particle.acceleration.y*(currentTime/1e3)*(currentTime/1e3)};var currentRotation=particle.rotation+particle.rotationSpeed*(currentTime/1e3);var currentAlpha=particle.alpha+particle.alphaSpeed*(currentTime/1e3);this.context.save();this.context.translate(particle.texture.width/2,particle.texture.height/2);this.context.translate(currentPosition.x,currentPosition.y);this.context.rotate(currentRotation);this.context.scale(Math.abs(currentScale),Math.abs(currentScale));this.context.translate(-particle.texture.width/2,-particle.texture.height/2);this.context.globalAlpha=Math.max(0,Math.min(1,currentAlpha));this.context.drawImage(texture,0,0,texture.width,texture.height,0,0,particle.size,particle.size);this.context.restore()};CanvasRenderer.prototype.addParticle=function(particle){var index=this.allParticles.length;var deathKeys=Object.keys(this.deathRange);for(var nIndex=0;nIndex<deathKeys.length;nIndex++){var deathKey=parseInt(deathKeys[nIndex]);if(deathKey<this.currentTime){if(this.deathRange[deathKey].length>0){index=this.deathRange[deathKey].shift();break}else{delete this.deathRange[deathKey]}}}particle.startLife=this.currentTime+particle.delay;if(particle.alphaSpeed<0){var alphaLife=(0-particle.alpha/particle.alphaSpeed)*1e3;particle.maxLife=Math.min(particle.maxLife,alphaLife)}if(!particle.repeat){var deathRangeIndex=particle.startLife+particle.maxLife-(particle.startLife+particle.maxLife)%1e3+1e3;if(!this.deathRange[deathRangeIndex]){this.deathRange[deathRangeIndex]=[]}this.deathRange[deathRangeIndex].push(index)}this.allParticles[index]=particle};return CanvasRenderer}();exports.CanvasRenderer=CanvasRenderer;var _Particle=function(){function _Particle(){this.size=0;this.delay=0;this.startLife=0;this.maxLife=0;this.repeat=false;this.position={x:0,y:0};this.velocity={x:0,y:0};this.acceleration={x:0,y:0};this.scale=1;this.scaleSpeed=0;this.alpha=1;this.alphaSpeed=0;this.rotation=0;this.rotationSpeed=0}return _Particle}()},{"../renderer":6}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Cell=void 0;var Cell=function(){function Cell(identifier){this.identifier=identifier;this.birthRate=1;this.lifttime=0;this.lifttimeRange=0;this.velocity=0;this.velocityRange=0;this.alphaSpeed=0;this.alphaRange=0;this.acceleration={x:0,y:0};this.scale=1;this.scaleSpeed=0;this.scaleRange=0;this.emissionLongitude=0;this.emissionRange=0;this.spin=0;this.spinRange=0}return Cell}();exports.Cell=Cell},{}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Emitter=void 0;var types_1=require("./types");var Emitter=function(){function Emitter(){this.emitterPosition={x:0,y:0};this.emitterSize={width:0,height:0};this.emitterShape=types_1.EmitterShape.point;this.emitterMode=types_1.EmitterMode.surface;this.birthRate=1;this.cells=[]}return Emitter}();exports.Emitter=Emitter},{"./types":7}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.EmitterMode=exports.EmitterShape=exports.Cell=exports.Emitter=exports.Player=void 0;var player_1=require("./player");var emitter_1=require("./emitter");var cell_1=require("./cell");var types_1=require("./types");exports.Player=player_1.Player;exports.Emitter=emitter_1.Emitter;exports.Cell=cell_1.Cell;exports.EmitterShape=types_1.EmitterShape;exports.EmitterMode=types_1.EmitterMode},{"./cell":2,"./emitter":3,"./player":5,"./types":7}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.Player=void 0;var canvas_renderer_1=require("./canvas/canvas_renderer");var webgl_renderer_1=require("./webgl/webgl_renderer");var canUseWebGL=function(){var canvas=document.createElement("canvas");var gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");if(gl&&gl instanceof WebGLRenderingContext){return true}else{return false}};var Player=function(){function Player(canvas){this.canvas=canvas;this.running=false;if(Player.canUseWebGL){try{this.renderer=new webgl_renderer_1.WebGLRenderer(canvas)}catch(error){this.renderer=new canvas_renderer_1.CanvasRenderer(canvas)}}else{this.renderer=new canvas_renderer_1.CanvasRenderer(canvas)}}Player.prototype.addEmitter=function(emitter){this.renderer.addEmitter(emitter)};Player.prototype.removeEmitter=function(emitter){this.renderer.removeEmitter(emitter)};Player.prototype.removeAllEmitters=function(){this.renderer.removeAllEmitters()};Player.prototype.start=function(){this.running=true;requestAnimationFrame(this.onTick.bind(this))};Player.prototype.stop=function(){this.running=false};Player.prototype.onTick=function(time){if(!this.running)return;this.renderer.onTick(time);requestAnimationFrame(this.onTick.bind(this))};Player.canUseWebGL=canUseWebGL();return Player}();exports.Player=Player},{"./canvas/canvas_renderer":1,"./webgl/webgl_renderer":9}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports._RotationAdjusting=exports.RendererUtils=void 0;var types_1=require("./types");var RendererUtils=function(){function RendererUtils(){}RendererUtils.getPosition=function(emitter,adjustRotation){if(emitter.emitterShape==types_1.EmitterShape.point){return emitter.emitterPosition}else if(emitter.emitterShape==types_1.EmitterShape.rectangle||emitter.emitterShape==types_1.EmitterShape.cuboid){if(emitter.emitterMode==types_1.EmitterMode.surface){return{x:emitter.emitterPosition.x-emitter.emitterSize.width/2+Math.random()*emitter.emitterSize.width,y:emitter.emitterPosition.y-emitter.emitterSize.height/2+Math.random()*emitter.emitterSize.height}}else if(emitter.emitterMode==types_1.EmitterMode.points){return{x:emitter.emitterPosition.x-emitter.emitterSize.width/2+Math.round(Math.random())*emitter.emitterSize.width,y:emitter.emitterPosition.y-emitter.emitterSize.height/2+Math.round(Math.random())*emitter.emitterSize.height}}else if(emitter.emitterMode==types_1.EmitterMode.outline){if(Math.random()<.5){var yValue=Math.round(Math.random());if(yValue==0){adjustRotation.value=Math.PI*1.5}else{adjustRotation.value=Math.PI*-1.5}return{x:emitter.emitterPosition.x-emitter.emitterSize.width/2+Math.random()*emitter.emitterSize.width,y:emitter.emitterPosition.y-emitter.emitterSize.height/2+yValue*emitter.emitterSize.height}}else{var xValue=Math.round(Math.random());if(xValue==0){adjustRotation.value=Math.PI*1}else{adjustRotation.value=0}return{x:emitter.emitterPosition.x-emitter.emitterSize.width/2+xValue*emitter.emitterSize.width,y:emitter.emitterPosition.y-emitter.emitterSize.height/2+Math.random()*emitter.emitterSize.height}}}else{return{x:emitter.emitterPosition.x-emitter.emitterSize.width/2+Math.random()*emitter.emitterSize.width,y:emitter.emitterPosition.y-emitter.emitterSize.height/2+Math.random()*emitter.emitterSize.height}}}else if(emitter.emitterShape==types_1.EmitterShape.circle||emitter.emitterShape==types_1.EmitterShape.sphere){if(emitter.emitterMode==types_1.EmitterMode.surface){var t=Math.PI*2*Math.random();var x=Math.random()*emitter.emitterSize.width/2*Math.cos(t);var y=Math.random()*emitter.emitterSize.height/2*Math.sin(t);return{x:emitter.emitterPosition.x+x,y:emitter.emitterPosition.y+y}}else if(emitter.emitterMode==types_1.EmitterMode.points){return emitter.emitterPosition}else if(emitter.emitterMode==types_1.EmitterMode.outline){var t=Math.PI*2*Math.random();var x=emitter.emitterSize.width/2*Math.cos(t);var y=emitter.emitterSize.height/2*Math.sin(t);adjustRotation.value=t;return{x:emitter.emitterPosition.x+x,y:emitter.emitterPosition.y+y}}else{var t=Math.PI*2*Math.random();var x=Math.random()*emitter.emitterSize.width/2*Math.cos(t);var y=Math.random()*emitter.emitterSize.height/2*Math.sin(t);return{x:emitter.emitterPosition.x+x,y:emitter.emitterPosition.y+y}}}else{return emitter.emitterPosition}};return RendererUtils}();exports.RendererUtils=RendererUtils;var _RotationAdjusting=function(){function _RotationAdjusting(){this.value=0}return _RotationAdjusting}();exports._RotationAdjusting=_RotationAdjusting},{"./types":7}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.EmitterMode=exports.EmitterShape=void 0;var EmitterShape;(function(EmitterShape){EmitterShape[EmitterShape["point"]=0]="point";EmitterShape[EmitterShape["line"]=1]="line";EmitterShape[EmitterShape["rectangle"]=2]="rectangle";EmitterShape[EmitterShape["circle"]=3]="circle";EmitterShape[EmitterShape["cuboid"]=4]="cuboid";EmitterShape[EmitterShape["sphere"]=5]="sphere"})(EmitterShape=exports.EmitterShape||(exports.EmitterShape={}));var EmitterMode;(function(EmitterMode){EmitterMode[EmitterMode["points"]=0]="points";EmitterMode[EmitterMode["outline"]=1]="outline";EmitterMode[EmitterMode["surface"]=2]="surface";EmitterMode[EmitterMode["volume"]=3]="volume"})(EmitterMode=exports.EmitterMode||(exports.EmitterMode={}))},{}],8:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.fs=exports.vs=void 0;exports.vs="\n\n// vec2(startTime, endTime, repeat)\nattribute vec3 a_life;\n// vec4(layout.x, layout.y, position.x, position.y)\nattribute vec4 a_position;\nattribute vec2 a_texCoord;\n// vec4(velocity.x, velocity.y, acceleration.x, acceleration.y)\nattribute vec4 a_speed;\n// vec3(alpha, alphaSpeed, textureId)\nattribute vec3 a_alpha;\n// vec2(scale, scaleSpeed)\nattribute vec2 a_scale;\n// vec2(rotation, rotationSpeed)\nattribute vec2 a_rotation;\nuniform vec2 u_resolution;\nuniform float u_time;\nvarying float v_alpha;\nvarying float v_textureId;\nvarying vec2 v_texCoord;\n\nvoid main() {\n  float currentTime = u_time - a_life.x;\n\n  if (a_life.z > 0.0) {\n    float nTime = u_time - a_life.x;\n    float segTime = a_life.y - a_life.x;\n    currentTime = nTime - floor(nTime / segTime) * segTime;\n  }\n  else if (currentTime < 0.0 || currentTime > a_life.y) {\n    gl_Position = vec4(0.0, 0.0, 0.0, 0.0);\n    return;\n  }\n\n  vec2 currentScale = vec2(a_scale.x + a_scale.y * (currentTime / 1000.0), a_scale.x + a_scale.y * (currentTime / 1000.0));\n  vec2 currentSpeed = a_speed.xy + a_speed.zw * (currentTime / 1000.0);\n  float currentRotation = a_rotation.x + a_rotation.y * (currentTime / 1000.0);\n  float currentAlpha = a_alpha.x + a_alpha.y * (currentTime / 1000.0);\n\n  vec2 rotatedPosition = vec2(\n      cos(currentRotation) * a_position.x - sin(currentRotation) * a_position.y,\n      sin(currentRotation) * a_position.x + cos(currentRotation) * a_position.y);\n  vec2 scaledPosition = rotatedPosition * currentScale;\n  vec2 finalPositioned = scaledPosition + vec2(a_position.zw) + currentSpeed * (currentTime / 1000.0);\n\n  vec2 zeroToOne = (finalPositioned.xy) / u_resolution;\n  vec2 zeroToTwo = zeroToOne * 2.0;\n  vec2 clipSpace = zeroToTwo - 1.0;\n  gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n  v_alpha = currentAlpha;\n  v_textureId = a_alpha.z;\n  v_texCoord = a_texCoord;\n}\n";exports.fs="\nprecision mediump float;\nvarying float v_alpha;\nvarying float v_textureId;\nvarying vec2 v_texCoord;\nuniform sampler2D u_textures[16];\n\nvoid main() {\n  int textureId = int(v_textureId);\n\n  if (textureId == 0) { gl_FragColor = texture2D(u_textures[0], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 1) { gl_FragColor = texture2D(u_textures[1], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 2) { gl_FragColor = texture2D(u_textures[2], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 3) { gl_FragColor = texture2D(u_textures[3], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 4) { gl_FragColor = texture2D(u_textures[4], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 5) { gl_FragColor = texture2D(u_textures[5], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 6) { gl_FragColor = texture2D(u_textures[6], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 7) { gl_FragColor = texture2D(u_textures[7], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 8) { gl_FragColor = texture2D(u_textures[8], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 9) { gl_FragColor = texture2D(u_textures[9], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 10) { gl_FragColor = texture2D(u_textures[10], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 11) { gl_FragColor = texture2D(u_textures[11], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 12) { gl_FragColor = texture2D(u_textures[12], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 13) { gl_FragColor = texture2D(u_textures[13], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 14) { gl_FragColor = texture2D(u_textures[14], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else if (textureId == 15) { gl_FragColor = texture2D(u_textures[15], v_texCoord) * vec4(1.0, 1.0, 1.0, v_alpha); }\n  else { gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); }\n}\n"},{}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.WebGLRenderer=void 0;var renderer_1=require("../renderer");var shaders_1=require("./shaders");function resizeCanvasToDisplaySize(canvas){var displayWidth=canvas.clientWidth;var displayHeight=canvas.clientHeight;var needResize=canvas.width!==displayWidth||canvas.height!==displayHeight;if(needResize){canvas.width=displayWidth;canvas.height=displayHeight}return needResize}var WebGLRenderer=function(){function WebGLRenderer(canvas){this.canvas=canvas;this.currentTime=0;this.birthedTime=-1;this.bufferStore={};this.emitterLayerModel=new _LayerModel;this.activeTextures=[];this.activeTexturesCache={};this.emitters=[];this.gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");if(!this.gl)throw"Fail to get webgl context.";var vsShader=this.gl.createShader(this.gl.VERTEX_SHADER);this.gl.shaderSource(vsShader,shaders_1.vs);this.gl.compileShader(vsShader);var fsShader=this.gl.createShader(this.gl.FRAGMENT_SHADER);this.gl.shaderSource(fsShader,shaders_1.fs);this.gl.compileShader(fsShader);this.program=this.gl.createProgram();this.gl.attachShader(this.program,vsShader);this.gl.attachShader(this.program,fsShader);this.gl.linkProgram(this.program);this.lifeAttributeLocation=this.gl.getAttribLocation(this.program,"a_life");this.positionAttributeLocation=this.gl.getAttribLocation(this.program,"a_position");this.texCoordAttributeLocation=this.gl.getAttribLocation(this.program,"a_texCoord");this.speedAttributeLocation=this.gl.getAttribLocation(this.program,"a_speed");this.alphaAttributeLocation=this.gl.getAttribLocation(this.program,"a_alpha");this.scaleAttributeLocation=this.gl.getAttribLocation(this.program,"a_scale");this.rotationAttributeLocation=this.gl.getAttribLocation(this.program,"a_rotation");this.resolutionUniformLocation=this.gl.getUniformLocation(this.program,"u_resolution");this.timeUniformLocation=this.gl.getUniformLocation(this.program,"u_time");this.texturesUniformLocation=this.gl.getUniformLocation(this.program,"u_textures");resizeCanvasToDisplaySize(this.gl.canvas);this.gl.disable(this.gl.DEPTH_TEST);this.gl.enable(this.gl.BLEND);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height);this.gl.useProgram(this.program);this.gl.uniform2f(this.resolutionUniformLocation,this.gl.canvas.width,this.gl.canvas.height)}WebGLRenderer.prototype.addEmitter=function(emitter){this.emitters.push(emitter)};WebGLRenderer.prototype.removeEmitter=function(emitter){var targetIndex=this.emitters.indexOf(emitter);if(targetIndex>=0){delete this.emitters[targetIndex]}};WebGLRenderer.prototype.removeAllEmitters=function(){this.emitters=[]};WebGLRenderer.prototype.onTick=function(time){this.currentTime=time;this.gl.useProgram(this.program);this.gl.uniform1f(this.timeUniformLocation,this.currentTime);this.birth();this.render()};WebGLRenderer.prototype.createTexture=function(image){var textureIndex=this.activeTextures.length;var texture=this.gl.createTexture();this.gl.activeTexture(this.gl.TEXTURE0+textureIndex);this.gl.bindTexture(this.gl.TEXTURE_2D,texture);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,image);this.activeTextures.push(textureIndex);var textureIds=[];for(var tIndex=0;tIndex<textureIndex+1;tIndex++){textureIds.push(tIndex)}this.gl.uniform1iv(this.texturesUniformLocation,textureIds);return textureIndex};WebGLRenderer.prototype.birth=function(){var _a,_b,_c;if(this.birthedTime<0||this.birthedTime+1e3<this.currentTime){for(var emitterIndex=0;emitterIndex<this.emitters.length;emitterIndex++){var emitter=this.emitters[emitterIndex];for(var cellIndex=0;cellIndex<emitter.cells.length;cellIndex++){var cell=emitter.cells[cellIndex];var cellBirthRate=emitter.birthRate*cell.birthRate;if(!cell.contents||cell.contents.width<=0)continue;for(var index=0;index<cellBirthRate;index++){var particle=new _Particle;particle.textureId=(_a=this.activeTexturesCache[cell.contents.src])!==null&&_a!==void 0?_a:this.createTexture(cell.contents);this.activeTexturesCache[cell.contents.src]=particle.textureId;particle.size=(_c=(_b=cell.contents)===null||_b===void 0?void 0:_b.width)!==null&&_c!==void 0?_c:0;particle.delay=Math.random()*1e3;particle.maxLife=(cell.lifttime+-cell.lifttimeRange/2+Math.random()*cell.lifttimeRange)*1e3;var adjustRotation=new renderer_1._RotationAdjusting;particle.position=renderer_1.RendererUtils.getPosition(emitter,adjustRotation);var emissionLongitude=cell.emissionLongitude-cell.emissionRange/2+Math.random()*cell.emissionRange;if(adjustRotation.value!=0){emissionLongitude+=adjustRotation.value}var theXPositionSpeed=cell.velocity-cell.velocityRange/2+Math.random()*cell.velocityRange;particle.velocity={x:theXPositionSpeed*Math.cos(emissionLongitude),y:theXPositionSpeed*Math.sin(emissionLongitude)};particle.acceleration=cell.acceleration;particle.scale=cell.scale-cell.scaleRange/2+Math.random()*cell.scaleRange;particle.scaleSpeed=cell.scaleSpeed;particle.alpha=1-cell.alphaRange/2+Math.random()*cell.alphaRange;particle.alphaSpeed=cell.alphaSpeed;particle.rotation=0;particle.rotationSpeed=cell.spin-cell.spinRange/2+Math.random()*cell.spinRange;this.emitterLayerModel.addParticle(particle,this.currentTime)}}}this.birthedTime=this.currentTime}};WebGLRenderer.prototype.render=function(){var _this=this;if(this.emitterLayerModel.numberOfParticles()==0){return}this.gl.clearColor(0,0,0,0);this.gl.clear(this.gl.COLOR_BUFFER_BIT);if(this.emitterLayerModel.dirtied){["life","position","texCoord","speed","alpha","scale","rotation"].forEach(function(type){var _a;var buffered=_this.bufferStore[type]!==undefined;var buffer=(_a=_this.bufferStore[type])!==null&&_a!==void 0?_a:_this.gl.createBuffer();_this.bufferStore[type]=buffer;_this.gl.bindBuffer(_this.gl.ARRAY_BUFFER,buffer);if(_this.emitterLayerModel.dirtyIndexes.length>0&&_this.emitterLayerModel.dirtyIndexes.length<_this.emitterLayerModel.numberOfParticles()/3){_this.emitterLayerModel.dirtyIndexes.forEach(function(idx){var offset=2*6*idx;var length=2*6;if(type==="speed"||type==="position"){offset=4*6*idx;length=4*6}else if(type==="life"){offset=3*6*idx;length=3*6}else if(type==="alpha"){offset=3*6*idx;length=3*6}var data=_this.emitterLayerModel[type].slice(offset,offset+length);_this.gl.bufferSubData(_this.gl.ARRAY_BUFFER,offset*4,new Float32Array(data))})}else{_this.gl.bufferData(_this.gl.ARRAY_BUFFER,new Float32Array(_this.emitterLayerModel[type]),_this.gl.DYNAMIC_DRAW)}if(!buffered){_this.gl.enableVertexAttribArray(_this[type+"AttributeLocation"]);_this.gl.bindBuffer(_this.gl.ARRAY_BUFFER,buffer);var count=2;if(type==="speed"||type==="position"){count=4}else if(type==="life"){count=3}else if(type==="alpha"){count=3}_this.gl.vertexAttribPointer(_this[type+"AttributeLocation"],count,_this.gl.FLOAT,false,0,0)}});this.emitterLayerModel.dirtied=false;this.emitterLayerModel.dirtyIndexes=[]}this.gl.drawArrays(this.gl.TRIANGLES,0,this.emitterLayerModel.numberOfParticles()*6)};return WebGLRenderer}();exports.WebGLRenderer=WebGLRenderer;var _LayerModel=function(){function _LayerModel(){this.allParticles=[];this.life=[];this.position=[];this.speed=[];this.alpha=[];this.scale=[];this.rotation=[];this.texCoord=[];this.deathRange={};this.dirtied=true;this.dirtyIndexes=[]}_LayerModel.prototype.addParticle=function(model,currentTime){this.dirtied=true;var needPush=true;var index=this.allParticles.length;var deathKeys=Object.keys(this.deathRange);for(var nIndex=0;nIndex<deathKeys.length;nIndex++){var deathKey=parseInt(deathKeys[nIndex]);if(deathKey<currentTime){if(this.deathRange[deathKey].length>0){index=this.deathRange[deathKey].shift();this.dirtyIndexes.push(index);needPush=false;break}else{delete this.deathRange[deathKey]}}}if(needPush){this.dirtyIndexes=[]}model.startLife=currentTime+model.delay;if(model.alphaSpeed<0){var alphaLife=(0-model.alpha/model.alphaSpeed)*1e3;model.maxLife=Math.min(model.maxLife,alphaLife)}if(!model.repeat){var deathRangeIndex=model.startLife+model.maxLife-(model.startLife+model.maxLife)%1e3+1e3;if(!this.deathRange[deathRangeIndex]){this.deathRange[deathRangeIndex]=[]}this.deathRange[deathRangeIndex].push(index)}this.allParticles[index]=model;this.resetBufferData(this.life,index*18,[model.startLife,model.startLife+model.maxLife,model.repeat?1:0,model.startLife,model.startLife+model.maxLife,model.repeat?1:0,model.startLife,model.startLife+model.maxLife,model.repeat?1:0,model.startLife,model.startLife+model.maxLife,model.repeat?1:0,model.startLife,model.startLife+model.maxLife,model.repeat?1:0,model.startLife,model.startLife+model.maxLife,model.repeat?1:0]);this.resetBufferData(this.position,index*24,[-model.size/2,-model.size/2,model.position.x,model.position.y,+model.size/2,-model.size/2,model.position.x,model.position.y,+model.size/2,+model.size/2,model.position.x,model.position.y,-model.size/2,-model.size/2,model.position.x,model.position.y,+model.size/2,+model.size/2,model.position.x,model.position.y,-model.size/2,+model.size/2,model.position.x,model.position.y]);this.resetBufferData(this.texCoord,index*12,[0,0,1,0,1,1,0,0,1,1,0,1]);this.resetBufferData(this.speed,index*24,[model.velocity.x,model.velocity.y,model.acceleration.x,model.acceleration.y,model.velocity.x,model.velocity.y,model.acceleration.x,model.acceleration.y,model.velocity.x,model.velocity.y,model.acceleration.x,model.acceleration.y,model.velocity.x,model.velocity.y,model.acceleration.x,model.acceleration.y,model.velocity.x,model.velocity.y,model.acceleration.x,model.acceleration.y,model.velocity.x,model.velocity.y,model.acceleration.x,model.acceleration.y]);this.resetBufferData(this.alpha,index*18,[model.alpha,model.alphaSpeed,model.textureId,model.alpha,model.alphaSpeed,model.textureId,model.alpha,model.alphaSpeed,model.textureId,model.alpha,model.alphaSpeed,model.textureId,model.alpha,model.alphaSpeed,model.textureId,model.alpha,model.alphaSpeed,model.textureId]);this.resetBufferData(this.scale,index*12,[model.scale,model.scaleSpeed,model.scale,model.scaleSpeed,model.scale,model.scaleSpeed,model.scale,model.scaleSpeed,model.scale,model.scaleSpeed,model.scale,model.scaleSpeed]);this.resetBufferData(this.rotation,index*12,[model.rotation,model.rotationSpeed,model.rotation,model.rotationSpeed,model.rotation,model.rotationSpeed,model.rotation,model.rotationSpeed,model.rotation,model.rotationSpeed,model.rotation,model.rotationSpeed])};_LayerModel.prototype.resetBufferData=function(bufferData,offset,data){for(var index=offset,dataIndex=0;index<offset+data.length;index++,dataIndex++){bufferData[index]=data[dataIndex]}};_LayerModel.prototype.numberOfParticles=function(){return this.allParticles.length};return _LayerModel}();var _Particle=function(){function _Particle(){this.textureId=-1;this.size=0;this.delay=0;this.startLife=0;this.maxLife=0;this.repeat=false;this.position={x:0,y:0};this.velocity={x:0,y:0};this.acceleration={x:0,y:0};this.scale=1;this.scaleSpeed=0;this.alpha=1;this.alphaSpeed=0;this.rotation=0;this.rotationSpeed=0}return _Particle}()},{"../renderer":6,"./shaders":8}]},{},[4])(4)});
